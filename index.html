<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Punto de Venta - Petshop con Excel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Incluir SheetJS desde CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Incluir Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Incluir Select2 CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
    <style>
        /* Estilos anteriores se mantienen igual */
        /* ... (todos los estilos anteriores) ... */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #4a6fa5;
            --secondary: #ff914d;
            --success: #66bb6a;
            --light: #f8f9fa;
            --dark: #343a40;
            --gray: #6c757d;
            --light-gray: #e9ecef;
        }

        body {
            background-color: #f5f7fa;
            color: var(--dark);
        }

        .container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        header {
            background: linear-gradient(135deg, var(--primary), #2c5282);
            color: white;
            padding: 1.2rem 2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo i {
            font-size: 2.2rem;
            color: var(--secondary);
        }

        .logo h1 {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .date-time {
            text-align: right;
            font-size: 1rem;
        }

        .main-content {
            display: flex;
            flex: 1;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            padding: 20px;
            gap: 20px;
        }

        .products-section {
            flex: 3;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            padding: 20px;
        }

        .cart-section {
            flex: 2;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .section-title {
            font-size: 1.4rem;
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light-gray);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            color: var(--secondary);
        }

        .categories {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .category-btn {
            padding: 8px 16px;
            background-color: var(--light-gray);
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .category-btn.active,
        .category-btn:hover {
            background-color: var(--primary);
            color: white;
        }

        /* New styles for subcategories */
        .subcategory-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
            margin-left: 20px; /* Indent subcategories */
            border-left: 3px solid var(--light-gray);
            padding-left: 10px;
        }

        .subcategory-btn {
            padding: 6px 12px;
            background-color: #e3f2fd; /* Lighter background for subcategories */
            color: var(--primary);
            border: 1px solid var(--primary);
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .subcategory-btn.active,
        .subcategory-btn:hover {
            background-color: var(--primary);
            color: white;
        }

        .products-grid { /* This style is no longer used for product display but kept for reference */
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            max-height: 500px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .product-card { /* This style is no longer used for product display but kept for reference */
            background-color: white;
            border-radius: 8px;
            border: 1px solid var(--light-gray);
            padding: 15px;
            display: flex;
            flex-direction: column;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .product-card:hover { /* This style is no longer used for product display but kept for reference */
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .product-img {
            height: 120px;
            background-color: var(--light-gray);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            color: var(--gray);
            font-size: 2.5rem;
        }

        /* New style for product images */
        .product-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .product-name { /* Adjusted for table cell */
            font-weight: 600;
            font-size: 1.1rem;
        }

        .product-price { /* Adjusted for table cell */
            color: var(--secondary);
            font-weight: 700;
            font-size: 1.2rem;
        }

        .product-stock { /* Adjusted for table cell */
            font-size: 0.95rem;
            color: var(--gray);
        }

        .add-to-cart {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 8px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
            width: 100%; /* Make button fill table cell */
        }

        .add-to-cart:hover {
            background-color: #3a5a8a;
        }

        .cart-items {
          flex: 1;
          overflow-y: auto;
          margin-bottom: 20px;
          max-height: 400px;
        }
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--light-gray);
        }
        .cart-item-info h4 {
              font-size: 1rem;
            margin-bottom: 5px;
        }
        .cart-item-price {
            color: var(--secondary);
            font-weight: 600;
        }
        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .quantity-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 1px solid var(--primary);
            background-color: white;
            color: var(--primary);
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .quantity-btn:hover {
            background-color: var(--primary);
            color: white;
        }

        .item-quantity {
            font-weight: 600;
            width: 100px;
            text-align: center;
            padding: 5px;
            border: 1px solid var(--light-gray);
            border-radius: 5px;
        }

        .remove-item {
            color: #e74c3c;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            margin-left: 10px;
        }

        .cart-summary {
            border-top: 2px solid var(--light-gray);
            padding-top: 20px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .total-row {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary);
            border-top: 1px solid var(--light-gray);
            padding-top: 15px;
            margin-top: 10px;
        }

        .checkout-btn {
            background-color: var(--success);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            transition: background-color 0.3s;
        }

        .checkout-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .empty-cart {
            text-align: center;
            color: var(--gray);
            padding: 40px 0;
        }

        .empty-cart i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: var(--light-gray);
        }

        .receipt-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .receipt-content {
            background-color: white;
            width: 90%;
            max-width: 500px;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .receipt-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .receipt-header h2 {
            color: var(--primary);
            margin-bottom: 5px;
        }

        .receipt-details {
            margin-bottom: 25px;
        }

        .receipt-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #ddd;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            border: none;
        }

        .print-btn {
            background-color: var(--primary);
            color: white;
        }

        .close-btn {
            background-color: var(--light-gray);
            color: var(--dark);
        }

        footer {
            display: flex;
            align-items:center;
            justify-content: center;
            background-color: var(--dark);
            color: white;
            text-align: center;
            padding: 15px;
            margin-top: 20px;
        }

        @media (max-width: 1024px) {
            .main-content {
                flex-direction: column;
            }

            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }

            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }

        /* Nuevos estilos para la gestión de Excel */
        .excel-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .file-input-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .file-input-label {
            background-color: #4a6fa5;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .file-input-label:hover {
            background-color: #3a5a8a;
        }

        .file-input {
            display: none;
        }

        .excel-actions {
            display: flex;
            gap: 10px;
        }

        .excel-btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .export-btn {
            background-color: #28a745;
            color: white;
        }

        .export-btn:hover {
            background-color: #218838;
        }

        .download-template-btn {
            background-color: #6c757d;
            color: white;
        }

        .download-template-btn:hover {
            background-color: #5a6268;
        }

        .status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            text-align: center;
            font-weight: 500;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* Estilos para la barra de búsqueda */
        .search-bar {
            display: flex;
            align-items: center;
            background-color: var(--light);
            border-radius: 25px;
            padding: 8px 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .search-bar input {
            border: none;
            outline: none;
            background: transparent;
            flex-grow: 1;
            padding: 5px 10px;
            font-size: 1rem;
            color: var(--dark);
        }

        .search-bar input::placeholder {
            color: var(--gray);
        }

        .search-bar i {
            color: var(--gray);
            margin-right: 10px;
        }

        /* Estilos para los modales de gestión de productos */
        .product-management-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .product-management-modal .receipt-content {
            background-color: white;
            width: 90%;
            max-width: 600px; /* Un poco más grande para el formulario */
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .product-management-modal .receipt-header h2 {
            margin-bottom: 15px;
            text-align: center;
        }

        .product-management-modal .form-group {
            margin-bottom: 15px;
        }

        .product-management-modal .modal-buttons {
            margin-top: 20px;
        }

        /* Estilos para el botón de 'Gestión de Productos' */
        .manage-products-btn {
            background-color: var(--dark);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
        }
        .manage-products-btn:hover {
            background-color: #3a5a8a;
        }

        /* Estilos para los botones de editar/eliminar en tarjetas de producto */
        .product-card .actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            justify-content: flex-end;
        }

        .product-card .edit-btn {
            background-color: var(--primary);
            color: white;
        }

        .product-card .edit-btn:hover {
            background-color: #3a5a8a;
        }

        .product-card .delete-btn {
            background-color: #dc3545;
            color: white;
        }

        .product-card .delete-btn:hover {
            background-color: #c82333;
        }

        .product-management-options {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        /* New style to hide edit buttons initially */
        .hidden-edit-button {
            display: none !important;
        }

        /* New styles for product table */
        .products-table-container {
            max-height: 500px;
            overflow-y: auto;
            padding-right: 5px;
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            background-color: white;
        }

        .products-table {
            width: 100%;
            border-collapse: collapse;
        }

        .products-table th,
        .products-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--light-gray);
        }

        .products-table th {
            background-color: var(--light-gray);
            font-weight: 600;
            color: var(--dark);
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .products-table tbody tr:hover {
            background-color: #f5f5f5;
        }

        .products-table td:last-child {
            text-align: center;
        }

        .products-table .product-image-thumb {
            width: 50px;
            height: 50px;
            object-fit: contain;
            vertical-align: middle;
            margin-right: 10px;
        }

        .products-table .product-name-col {
            display: flex;
            align-items: center;
        }

        .products-table .action-buttons-cell {
            display: flex;
            gap: 5px;
            justify-content: center;
            flex-wrap: nowrap; /* Prevent wrapping */
        }

        .products-table .action-buttons-cell button {
            white-space: nowrap;
        }

        /* Styles for pagination controls */
        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            padding: 10px 0;
            border-top: 1px solid var(--light-gray);
        }

        .pagination-btn {
            padding: 8px 15px;
            border: 1px solid var(--primary);
            border-radius: 5px;
            background-color: white;
            color: var(--primary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .pagination-btn:hover:not(:disabled) {
            background-color: var(--primary);
            color: white;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-number {
            font-weight: 600;
            color: var(--dark);
        }
        /* Adjust Select2 to match Bootstrap styling */
        .select2-container .select2-selection--single {
            height: calc(1.5em + .75rem + 2px) !important;
            border: 1px solid #ced4da !important;
            border-radius: .25rem !important;
        }
        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: calc(1.5em + .75rem + 2px) !important;
            top: 0 !important;
            right: 1px !important;
        }
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: calc(1.5em + .75rem) !important;
            padding-left: .75rem !important;
            color: #495057 !important;
        }
        .select2-dropdown {
            border: 1px solid #ced4da !important;
            border-radius: .25rem !important;
        }
        .select2-search--dropdown .select2-search__field {
            border: 1px solid #ced4da !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-paw"></i>
                    <h1>PetShop - Punto de Venta</h1>
                </div>
                <div class="date-time">
                    <div id="current-date"></div>
                    <div id="current-time"></div>
                </div>
            </div>
        </header>

        <div class="main-content">
            <section class="products-section">
                <div class="excel-controls hidden-edit-button">
                    <div class="file-input-container">
                        <label for="excel-file" class="file-input-label">
                            <i class="fas fa-file-excel"></i> Cargar Excel
                        </label>
                        <input type="file" id="excel-file" class="file-input" accept=".xlsx, .xls, .csv">
                        <div class="file-info" id="file-info">No se ha cargado ningún archivo</div>
                    </div>

                    <div class="excel-actions">
                        <button class="excel-btn download-template-btn" id="download-template">
                            <i class="fas fa-download"></i> Plantilla
                        </button>
                        <button class="excel-btn export-btn" id="export-products">
                            <i class="fas fa-file-export"></i> Exportar Productos
                        </button>
                        <button class="excel-btn export-sales-btn" id="export-sales">
                            <i class="fas fa-file-invoice-dollar"></i> Exportar Ventas
                        </button>
                    </div>
                </div>

                <div id="status-message"></div>

                <!-- Product Management Buttons -->
                <div class="product-management-options">
                    <button class="manage-products-btn hidden-edit-button" id="open-add-product-modal-btn">
                        <i class="fas fa-plus"></i> Agregar Nuevo Producto
                    </button>
                </div>
                <!-- End Product Management Buttons -->

                <!-- Barra de búsqueda agregada aquí -->
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" id="search-input" placeholder="Buscar productos..." autofocus>
                </div>

                <div class="mb-3">
                    <label for="category-filter" class="form-label">Filtrar por Categoría:</label>
                    <select class="form-select" id="category-filter"></select>
                </div>

                <!-- Example Subcategory container - will be populated dynamically -->
                <div id="subcategories-container" class="subcategory-container">
                    <!-- Subcategory buttons will be rendered here by JavaScript -->
                </div>

                <div class="products-table-container" id="products-container">
                    <!-- Los productos se cargarán aquí con JavaScript -->
                </div>

                <!-- Pagination Controls -->
                <div class="pagination-controls" id="pagination-controls">
                    <button class="pagination-btn" id="prev-page-btn" disabled><i class="fas fa-chevron-left"></i> Anterior</button>
                    <span id="page-info" class="page-number">Página 1 de 1</span>
                    <button class="pagination-btn" id="next-page-btn" disabled>Siguiente <i class="fas fa-chevron-right"></i></button>
                </div>
                <!-- End Pagination Controls -->

            </section>

            <section class="cart-section">
                <h2 class="section-title"><i class="fas fa-shopping-cart"></i> Carrito de Compra</h2>

                <div class="cart-items" id="cart-items">
                    <div class="empty-cart" id="empty-cart">
                        <i class="fas fa-shopping-cart"></i>
                        <p>El carrito está vacío</p>
                        <p>Agrega productos desde la lista</p>
                    </div>
                    <!-- Los items del carrito se cargarán aquí con JavaScript -->
                </div>

                <div class="cart-summary">
                    <div class="summary-row">
                        <span>Subtotal:</span>
                        <span id="subtotal">$0.00</span>
                    </div>

                    <div class="summary-row total-row">
                        <span>Total:</span>
                        <span id="total">$0.00</span>
                    </div>

                    <button class="checkout-btn" id="checkout-btn" disabled>
                        <i class="fas fa-cash-register"></i> Procesar Venta
                    </button>
                </div>
            </section>
        </div>

        <!-- Modal de recibo -->
        <div class="receipt-modal" id="receipt-modal">
            <div class="receipt-content">
                <div class="receipt-header">
                    <h2>¡Venta Realizada!</h2>
                    <p>Recibo de compra</p>
                    <p id="receipt-id">ID: PS-00123</p>
                </div>

                <div class="receipt-details">
                    <div class="receipt-item">
                        <span>Fecha:</span>
                        <span id="receipt-date">01/01/2023</span>
                    </div>
                    <div class="receipt-item">
                        <span>Hora:</span>
                        <span id="receipt-time">10:30 AM</span>
                    </div>
                    <div id="receipt-items">
                        <!-- Los items del recibo se cargarán aquí -->
                    </div>
                    <div class="receipt-item" style="font-weight: bold; border-bottom: none; padding-top: 10px;">
                        <span>Total:</span>
                        <span id="receipt-total">$0.00</span>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="modal-btn print-btn" id="print-btn">
                        <i class="fas fa-print"></i> Imprimir
                    </button>
                    <button class="modal-btn close-btn" id="close-receipt-btn">
                        <i class="fas fa-times"></i> Cerrar
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal para agregar producto -->
        <div class="receipt-modal" id="add-product-modal">
            <div class="receipt-content">
                <div class="receipt-header">
                    <h2><i class="fas fa-plus-circle"></i> Agregar Nuevo Producto</h2>
                </div>
                <div id="add-product-form-status-message"></div>
                <form id="add-product-form" class="product-form">
                    <div class="mb-3">
                        <label for="add-product-name" class="form-label">Nombre del producto</label>
                        <input type="text" class="form-control" id="add-product-name" placeholder="Ej: Alimento premium perro adulto" required>
                    </div>
                    <div class="mb-3">
                        <label for="add-product-price" class="form-label">Precio</label>
                        <input type="number" class="form-control" id="add-product-price" placeholder="Ej: 55.75" min="0.01" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label for="add-product-category" class="form-label">Categoría</label>
                        <input type="text" class="form-control" id="add-product-category" placeholder="Ej: food, toys, health, accessories" required>
                    </div>
                    <div class="mb-3">
                        <label for="add-product-stock" class="form-label">Stock</label>
                        <input type="number" class="form-control" id="add-product-stock" placeholder="Ej: 20" min="0" required>
                    </div>
                    <!-- Remove 'Icono' and 'Subcategoría' fields -->
                    <!--
                    <div class="mb-3">
                        <label for="add-product-icon" class="form-label">URL de Imagen (para el producto)</label>
                        <input type="text" class="form-control" id="add-product-icon" placeholder="Ej: https://example.com/imagen.jpg">
                    </div>
                    -->
                    <div class="modal-buttons">
                        <button type="submit" class="modal-btn btn btn-primary" id="add-product-btn">
                            <i class="fas fa-plus"></i> Agregar Producto
                        </button>
                        <button type="button" class="modal-btn btn btn-secondary" id="close-add-product-modal-btn">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal para actualizar producto -->
        <div class="receipt-modal" id="update-product-modal">
            <div class="receipt-content">
                <div class="receipt-header">
                    <h2><i class="fas fa-edit"></i> Actualizar Producto</h2>
                </div>
                <div id="update-product-form-status-message"></div>
                <form id="update-product-form" class="product-form">
                    <input type="hidden" id="update-product-id">
                    <div class="mb-3">
                        <label for="update-product-name" class="form-label">Nombre del producto</label>
                        <input type="text" class="form-control" id="update-product-name" placeholder="Ej: Alimento premium perro adulto" required>
                    </div>
                    <div class="mb-3">
                        <label for="update-product-price" class="form-label">Precio</label>
                        <input type="number" class="form-control" id="update-product-price" placeholder="Ej: 55.75" min="0.01" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label for="update-product-category" class="form-label">Categoría</label>
                        <input type="text" class="form-control" id="update-product-category" placeholder="Ej: food, toys, health, accessories" required>
                    </div>
                    <div class="mb-3">
                        <label for="update-product-stock" class="form-label">Stock</label>
                        <input type="number" class="form-control" id="update-product-stock" placeholder="Ej: 20" min="0" required>
                    </div>
                    <!-- Remove 'Icono' and 'Subcategoría' fields -->
                    <!--
                    <div class="mb-3">
                        <label for="update-product-icon" class="form-label">URL de Imagen (para el producto)</label>
                        <input type="text" class="form-control" id="update-product-icon" placeholder="Ej: https://example.com/imagen.jpg">
                    </div>
                    -->
                    <div class="modal-buttons">
                        <button type="submit" class="modal-btn btn btn-primary" id="update-product-btn">
                            <i class="fas fa-save"></i> Actualizar Producto
                        </button>
                        <button type="button" class="modal-btn btn btn-secondary" id="close-update-product-modal-btn">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <footer>
          <button class="manage-products-btn" id="toggle-edit-mode-btn">
            <i class="fa-solid fa-copyright"></i>
          </button>
          <p>PetShop - Sistema de Punto de Venta</p>
        </footer>
    </div>

    <!-- Incluir jQuery (requerido por Select2) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- Incluir Select2 JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

    <script>
        // Datos iniciales (se cargarán desde Excel)
        let products = [];
        let sales = []; // New array to store sales

        // Configuración para el archivo Excel
        const EXCEL_CONFIG = {
            sheetName: 'Productos',
            headers: ['ID', 'Nombre', 'Precio', 'Categoría', 'Stock', 'Fecha Creación', 'Última Actualización', 'Stock Previo'],
            mappings: {
                id: 'ID',
                name: 'Nombre',
                price: 'Precio',
                category: 'Categoría',
                stock: 'Stock',
                creationDate: 'Fecha Creación',
                lastUpdateDate: 'Última Actualización',
                previousStock: 'Stock Previo'
            }
        };

        // Configuration for Sales Excel
        const EXCEL_CONFIG_SALES = {
            sheetName: 'Ventas',
            headers: ['ID Venta', 'Fecha', 'Hora', 'Nombre Producto', 'Cantidad', 'Precio Unitario', 'Total Producto'],
            mappings: {
                id: 'ID Venta',
                date: 'Fecha',
                time: 'Hora',
                productName: 'Nombre Producto',
                quantity: 'Cantidad',
                unitPrice: 'Precio Unitario',
                itemTotal: 'Total Producto'
            }
        };

        // Carrito de compras
        let cart = [];
        let currentCategory = 'all';
        let currentSubcategory = 'all'; // Subcategory logic removed, but kept for now. Will be removed from rendering.

        // Pagination variables
        const productsPerPage = 5; // Number of products to display per page
        let currentPage = 1; // Current page number

        // Elementos del DOM
        const productsContainer = document.getElementById('products-container');
        const cartItemsContainer = document.getElementById('cart-items');
        const emptyCartElement = document.getElementById('empty-cart');
        const categoryFilterSelect = document.getElementById('category-filter'); // New DOM element for the select dropdown
        const subtotalElement = document.getElementById('subtotal');
        const totalElement = document.getElementById('total');
        const checkoutBtn = document.getElementById('checkout-btn');
        const receiptModal = document.getElementById('receipt-modal');
        const closeReceiptBtn = document.getElementById('close-receipt-btn');
        const printBtn = document.getElementById('print-btn');
        const currentDateElement = document.getElementById('current-date');
        const currentTimeElement = document.getElementById('current-time');
        const receiptDateElement = document.getElementById('receipt-date');
        const receiptTimeElement = document.getElementById('receipt-time');
        const receiptItemsElement = document.getElementById('receipt-items');
        const receiptTotalElement = document.getElementById('receipt-total');
        const receiptIdElement = document.getElementById('receipt-id');
        const searchInput = document.getElementById('search-input');
        const subcategoriesContainer = document.getElementById('subcategories-container'); // This container will now be hidden or removed
        const paginationControls = document.getElementById('pagination-controls');
        const prevPageBtn = document.getElementById('prev-page-btn');
        const nextPageBtn = document.getElementById('next-page-btn');
        const pageInfoSpan = document.getElementById('page-info');

        // Nuevos elementos para Excel
        const excelFileInput = document.getElementById('excel-file');
        const fileInfoElement = document.getElementById('file-info');
        const downloadTemplateBtn = document.getElementById('download-template');
        const exportProductsBtn = document.getElementById('export-products');
        const exportSalesBtn = document.getElementById('export-sales'); // New export sales button
        const statusMessageElement = document.getElementById('status-message');

        // Nuevos elementos para gestión de productos (modals)
        const openAddProductModalBtn = document.getElementById('open-add-product-modal-btn');
        const addProductModal = document.getElementById('add-product-modal');
        const closeAddProductModalBtn = document.getElementById('close-add-product-modal-btn');
        const addProductForm = document.getElementById('add-product-form');
        const addProductNameInput = document.getElementById('add-product-name');
        const addProductPriceInput = document.getElementById('add-product-price');
        const addProductCategoryInput = document.getElementById('add-product-category');
        const addProductStockInput = document.getElementById('add-product-stock');
        // const addProductIconInput = document.getElementById('add-product-icon'); // Removed
        const addProductFormStatusMessage = document.getElementById('add-product-form-status-message');

        const updateProductModal = document.getElementById('update-product-modal');
        const closeUpdateProductModalBtn = document.getElementById('close-update-product-modal-btn');
        const updateProductForm = document.getElementById('update-product-form');
        const updateProductIdInput = document.getElementById('update-product-id');
        const updateProductNameInput = document.getElementById('update-product-name');
        const updateProductPriceInput = document.getElementById('update-product-price');
        const updateProductCategoryInput = document.getElementById('update-product-category');
        const updateProductStockInput = document.getElementById('update-product-stock');
        // const updateProductIconInput = document.getElementById('update-product-icon'); // Removed
        const updateProductFormStatusMessage = document.getElementById('update-product-form-status-message');

        const toggleEditModeBtn = document.getElementById('toggle-edit-mode-btn'); // New DOM element
        let editModeActive = false; // To keep track of edit mode state
        const ADMIN_PASSWORD = 'admin'; // Define your admin password here
        const excelControls = document.querySelector('.excel-controls'); // Get the excel controls div

        // Función para mostrar mensajes de estado
        function showStatusMessage(message, type = 'info') {
            statusMessageElement.innerHTML = `<div class="status-message ${type}">${message}</div>`;

            // Auto-ocultar después de 5 segundos para mensajes de éxito/info
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    statusMessageElement.innerHTML = '';
                }, 5000);
            }
        }

        // Función para mostrar mensajes de estado para el formulario de producto
        function showAddProductFormStatusMessage(message, type = 'info') {
            addProductFormStatusMessage.innerHTML = `<div class="status-message ${type}">${message}</div>`;

            // Auto-ocultar después de 5 segundos para mensajes de éxito/info
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    addProductFormStatusMessage.innerHTML = '';
                }, 5000);
            }
        }

        function showUpdateProductFormStatusMessage(message, type = 'info') {
            updateProductFormStatusMessage.innerHTML = `<div class="status-message ${type}">${message}</div>`;

            // Auto-ocultar después de 5 segundos para mensajes de éxito/info
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    updateProductFormStatusMessage.innerHTML = '';
                }, 5000);
            }
        }

        // Función para descargar plantilla de Excel
        function downloadTemplate() {
            // Crear datos de ejemplo para la plantilla
            const templateData = [
                {
                    'ID': 1,
                    'Nombre': "Alimento para Perro Adulto",
                    'Precio': 450,
                    'Categoría': "food",
                    'Stock': 15,
                    'Fecha Creación': '2023-01-01 10:00:00',
                    'Última Actualización': '2023-01-01 10:00:00',
                    'Stock Previo': 15
                },
                {
                    'ID': 2,
                    'Nombre': "Alimento para Gato Adulto",
                    'Precio': 380,
                    'Categoría': "food",
                    'Stock': 12,
                    'Fecha Creación': '2023-01-01 10:05:00',
                    'Última Actualización': '2023-01-01 10:05:00',
                    'Stock Previo': 12
                },
                {
                    'ID': 3,
                    'Nombre': "Snacks para Perro",
                    'Precio': 120,
                    'Categoría': "food",
                    'Stock': 25,
                    'Fecha Creación': '2023-01-02 11:00:00',
                    'Última Actualización': '2023-01-02 11:00:00',
                    'Stock Previo': 25
                },
                {
                    'ID': 4,
                    'Nombre': "Pelota para Mascota",
                    'Precio': 85,
                    'Categoría': "toys",
                    'Stock': 30,
                    'Fecha Creación': '2023-01-02 11:15:00',
                    'Última Actualización': '2023-01-02 11:15:00',
                    'Stock Previo': 30
                },
                {
                    'ID': '',
                    'Nombre': '',
                    'Precio': '',
                    'Categoría': '',
                    'Stock': '',
                    'Fecha Creación': '',
                    'Última Actualización': '',
                    'Stock Previo': ''
                }
            ];

            // Crear hoja de trabajo
            const ws = XLSX.utils.json_to_sheet(templateData);

            // Crear libro de trabajo
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, EXCEL_CONFIG.sheetName);

            // Descargar archivo
            XLSX.writeFile(wb, 'plantilla_productos_petshop.xlsx');

            showStatusMessage('Plantilla descargada correctamente. Completa los datos y cárgala en el sistema.', 'success');
        }

        // Función para leer archivo Excel
        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();

                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });

                        // Obtener la primera hoja
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];

                        // Convertir a JSON
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);

                        // Validar que el archivo tenga las columnas necesarias
                        if (jsonData.length === 0) {
                            reject(new Error('El archivo Excel está vacío o no tiene datos en la primera hoja.'));
                            return;
                        }

                        // Verify that all required headers are present
                        const requiredHeaders = Object.values(EXCEL_CONFIG.mappings).filter(header => header !== undefined && header !== 'Fecha Creación' && header !== 'Última Actualización'); // Exclude dates from strict check
                        const actualHeaders = Object.keys(jsonData[0] || {});
                        const missingHeaders = requiredHeaders.filter(header => !actualHeaders.includes(header));

                        if (missingHeaders.length > 0) {
                            throw new Error(`El archivo Excel debe contener las siguientes columnas obligatorias: ${missingHeaders.join(', ')}. Por favor, usa la plantilla.`);
                        }

                        resolve(jsonData);
                    } catch (error) {
                        reject(new Error('Error al procesar el archivo Excel: ' + error.message));
                    }
                };

                reader.onerror = function() {
                    reject(new Error('Error al leer el archivo.'));
                };

                reader.readAsArrayBuffer(file);
            });
        }

        // Función para procesar datos del Excel y actualizar productos
        function processExcelData(excelData) {
            const processedProducts = [];

            excelData.forEach((row, index) => {
                // Saltar filas vacías
                if (!row[EXCEL_CONFIG.mappings.id] && !row[EXCEL_CONFIG.mappings.name]) {
                    return;
                }

                try {
                    // Validar y procesar cada campo
                    const id = parseInt(row[EXCEL_CONFIG.mappings.id]);
                    const name = String(row[EXCEL_CONFIG.mappings.name]).trim();
                    const price = parseFloat(row[EXCEL_CONFIG.mappings.price]);
                    const category = String(row[EXCEL_CONFIG.mappings.category]).trim().toLowerCase();
                    const stock = parseInt(row[EXCEL_CONFIG.mappings.stock]);
                    // const icon = String(row[EXCEL_CONFIG.mappings.icon] || '').trim(); // Removed
                    // const subcategory = String(row[EXCEL_CONFIG.mappings.subcategory] || '').trim().toLowerCase(); // Removed
                    const creationDate = String(row[EXCEL_CONFIG.mappings.creationDate] || new Date().toLocaleString()); // Default to now if not provided
                    const lastUpdateDate = String(row[EXCEL_CONFIG.mappings.lastUpdateDate] || new Date().toLocaleString()); // Default to now if not provided
                    const previousStock = parseInt(row[EXCEL_CONFIG.mappings.previousStock] || 0); // New field: Previous Stock

                    // Validaciones básicas
                    if (isNaN(id) || id <= 0) {
                        throw new Error(`ID inválido en fila ${index + 2}`);
                    }

                    if (!name || name.length === 0) {
                        throw new Error(`Nombre vacío en fila ${index + 2}`);
                    }

                    if (isNaN(price) || price <= 0) {
                        throw new Error(`Precio inválido en fila ${index + 2}`);
                    }

                    if (!category || category.length === 0) {
                        throw new Error(`Categoría vacía en fila ${index + 2}`);
                    }

                    if (isNaN(stock) || stock < 0) {
                        throw new Error(`Stock inválido en fila ${index + 2}`);
                    }

                    // Crear objeto producto
                    const product = {
                        id,
                        name,
                        price,
                        category,
                        stock,
                        // icon: icon || getDefaultImageUrlForCategory(category), // Removed
                        // subcategory: subcategory,
                        creationDate: creationDate,
                        lastUpdateDate: lastUpdateDate,
                        previousStock: previousStock // Added previousStock
                    };

                    processedProducts.push(product);

                } catch (error) {
                    console.warn(`Error en fila ${index + 2}: ${error.message}`);
                    showStatusMessage(`Advertencia en fila ${index + 2}: ${error.message}`, 'error');
                }
            });

            return processedProducts;
        }

        // Función para obtener icono por defecto según categoría (adaptada para URLs de imagen)
        // function getDefaultImageUrlForCategory(category) { // Removed
        //     const imageMap = {
        //         'food': 'https://via.placeholder.com/150/FF5733/FFFFFF?text=Food',
        //         'toys': 'https://via.placeholder.com/150/33FF57/FFFFFF?text=Toys',
        //         'health': 'https://via.placeholder.com/150/3357FF/FFFFFF?text=Health',
        //         'accessories': 'https://via.placeholder.com/150/FF33CC/FFFFFF?text=Accessory',
        //         'default': 'https://via.placeholder.com/150/cccccc/FFFFFF?text=Product'
        //     };

        //     return imageMap[category] || imageMap.default;
        // }

        // Función para exportar productos a Excel
        function exportToExcel() {
            if (products.length === 0) {
                showStatusMessage('No hay productos para exportar.', 'error');
                return;
            }

            // Preparar datos para exportación
            const exportData = products.map(product => ({
                'ID': product.id,
                'Nombre': product.name,
                'Precio': product.price,
                'Categoría': product.category,
                'Stock': product.stock,
                // 'Icono': product.icon, // Removed
                // 'Subcategoría': product.subcategory, // Removed
                'Fecha Creación': product.creationDate,
                'Última Actualización': product.lastUpdateDate,
                'Stock Previo': product.previousStock
            }));

            // Crear hoja de trabajo
            const ws = XLSX.utils.json_to_sheet(exportData);

            // Ajustar ancho de columnas
            const wscols = [
                {wch: 8},  // ID
                {wch: 40}, // Nombre
                {wch: 12}, // Precio
                {wch: 15}, // Categoría
                {wch: 8},  // Stock
                // {wch: 15}, // Icono // Removed
                // {wch: 20}, // Subcategoría // Removed
                {wch: 22}, // Fecha Creación
                {wch: 22},  // Última Actualización
                {wch: 15}  // Stock Previo
            ];
            ws['!cols'] = wscols;

            // Crear libro de trabajo
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Productos_Exportados');

            // Generar nombre de archivo con fecha
            const date = new Date();
            const dateStr = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
            const fileName = `productos_petshop_${dateStr}.xlsx`;

            // Descargar archivo
            XLSX.writeFile(wb, fileName);

            showStatusMessage(`Productos exportados correctamente: ${products.length} productos`, 'success');

            // Add confirmation and clear data for products only
            if (confirm('¿Deseas borrar los productos existentes después de la exportación? Esta acción es irreversible.')) {
                products = [];
                saveProductsToLocalStorage();
                renderCategories();
                // renderSubcategories(); // Subcategory logic removed
                renderProducts();
                updateCart(); // Update cart to reflect empty products if any are in cart
                showStatusMessage('Productos borrados exitosamente después de la exportación.', 'success');
            }
        }

        // Función para exportar ventas a Excel
        function exportSalesToExcel() {
            if (sales.length === 0) {
                showStatusMessage('No hay ventas para exportar.', 'error');
                return;
            }

            const exportData = [];
            sales.forEach(sale => {
                sale.items.forEach(item => {
                    exportData.push({
                        'ID Venta': sale.id,
                        'Fecha': sale.date,
                        'Hora': sale.time,
                        'Nombre Producto': item.name,
                        'Cantidad': item.quantity,
                        'Precio Unitario': item.price,
                        'Total Producto': (item.quantity * item.price).toFixed(2)
                    });
                });
            });

            const ws = XLSX.utils.json_to_sheet(exportData);

            const wscols = [
                {wch: 15}, // ID Venta
                {wch: 15}, // Fecha
                {wch: 15}, // Hora
                {wch: 40}, // Nombre Producto
                {wch: 10}, // Cantidad
                {wch: 15}, // Precio Unitario
                {wch: 15}  // Total Producto
            ];
            ws['!cols'] = wscols;

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, EXCEL_CONFIG_SALES.sheetName);

            const date = new Date();
            const dateStr = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
            const fileName = `ventas_petshop_${dateStr}.xlsx`;

            XLSX.writeFile(wb, fileName);

            showStatusMessage(`Ventas exportadas correctamente: ${exportData.length} registros de productos vendidos`, 'success');

            if (confirm('¿Deseas borrar los registros de ventas existentes después de la exportación? Esta acción es irreversible.')) {
                sales = [];
                saveSalesToLocalStorage();
                // No need to re-render categories/products/cart as only sales are affected
                showStatusMessage('Registros de ventas borrados exitosamente después de la exportación.', 'success');
            }
        }

        // Función para formatear precio
        function formatPrice(price) {
            return `$${price.toFixed(2)}`;
        }

        // Función para actualizar fecha y hora
        function updateDateTime() {
            const now = new Date();

            // Formatear fecha
            const optionsDate = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const formattedDate = now.toLocaleDateString('es-ES', optionsDate);
            currentDateElement.textContent = formattedDate;

            // Formatear hora
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            currentTimeElement.textContent = `${hours}:${minutes}:${seconds}`;

            // Actualizar cada segundo
            setTimeout(updateDateTime, 1000);
        }

        // Function to render subcategories based on the current category
        function renderSubcategories() {
            subcategoriesContainer.innerHTML = '';
            // No longer rendering subcategory buttons as the field has been removed.
            // We can optionally hide the entire subcategoriesContainer element if it's always empty.
            // subcategoriesContainer.style.display = 'none';
        }

        // Función para renderizar categorías dinámicamente
        function renderCategories() {
            categoryFilterSelect.innerHTML = ''; // Clear previous options

            // Add "Todos" option
            const allOption = document.createElement('option');
            allOption.value = 'all';
            allOption.textContent = 'Todas las Categorías';
            categoryFilterSelect.appendChild(allOption);

            const uniqueCategories = new Set(products.map(p => p.category));

            uniqueCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                categoryFilterSelect.appendChild(option);
            });

            // Initialize Select2 after options are rendered
            $(categoryFilterSelect).select2({
                placeholder: "Selecciona una categoría",
                allowClear: true // Option to clear selection
            });

            // Set the currently selected category in the dropdown (for Select2)
            $(categoryFilterSelect).val(currentCategory).trigger('change');
        }

        // Función para adjuntar event listeners a los botones de categoría
        function attachCategoryEventListeners() {
            $(categoryFilterSelect).on('change', (e) => {
                currentCategory = e.target.value;
                currentSubcategory = 'all'; // Subcategory logic removed
                // renderSubcategories(); // Subcategory logic removed
                currentPage = 1; // Reset to first page when category changes
                renderProducts();
            });
        }

        // Función para renderizar productos
        function renderProducts() {
            productsContainer.innerHTML = '';

            // Obtener el valor de búsqueda
            const searchTerm = searchInput.value.toLowerCase();

            // Filtrar productos por categoría, subcategoría y término de búsqueda
            let filteredProducts = products.filter(product => {
                const matchesCategory = currentCategory === 'all' || product.category === currentCategory;
                // const matchesSubcategory = currentSubcategory === 'all' || product.subcategory === currentSubcategory; // Subcategory logic removed
                const matchesSearch = product.name.toLowerCase().includes(searchTerm) ||
                                      product.category.toLowerCase().includes(searchTerm) ||
                                      String(product.id).includes(searchTerm);
                                      // (product.subcategory && product.subcategory.toLowerCase().includes(searchTerm)); // Subcategory logic removed

                // Excluir productos con stock 0
                const hasStock = product.stock > 0;

                return matchesCategory /*&& matchesSubcategory*/ && matchesSearch && hasStock; // Subcategory logic removed
            });

            // Mostrar mensaje si no hay productos
            if (products.length === 0) {
                productsContainer.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #6c757d;">
                        <i class="fas fa-database" style="font-size: 3rem; margin-bottom: 15px;"></i>
                        <h3>No hay productos cargados</h3>
                        <p>Carga un archivo Excel para importar productos</p>
                    </div>
                `;
                paginationControls.style.display = 'none'; // Hide pagination if no products
                return;
            }

            // Mostrar mensaje si no hay productos en la categoría o búsqueda
            if (filteredProducts.length === 0) {
                productsContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6c757d;">
                        <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 15px;"></i>
                        <h3>No se encontraron productos</h3>
                        <p>Ajusta tu búsqueda, selecciona otra categoría</p>
                    </div>
                `;
                paginationControls.style.display = 'none'; // Hide pagination if no products match filter
                return;
            }

            // Calculate total pages and adjust current page if necessary
            const totalPages = Math.ceil(filteredProducts.length / productsPerPage);
            if (currentPage > totalPages) currentPage = totalPages;
            if (currentPage < 1) currentPage = 1;

            // Get products for the current page
            const startIndex = (currentPage - 1) * productsPerPage;
            const endIndex = startIndex + productsPerPage;
            const productsToDisplay = filteredProducts.slice(startIndex, endIndex);

            // Create the table structure
            const table = document.createElement('table');
            table.className = 'products-table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Precio</th>
                        <th>Stock</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            `;
            const tbody = table.querySelector('tbody');

            productsToDisplay.forEach(product => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="product-name-col">
                            <span class="product-name">${product.name}</span>
                        </div>
                    </td>
                    <td><span class="product-price">${formatPrice(product.price)}</span></td>
                    <td><span class="product-stock">${product.stock} unidades</span></td>
                    <td>
                        <div class="action-buttons-cell">
                            <button class="add-to-cart btn btn-sm btn-primary" data-id="${product.id}">
                                <i class="fas fa-cart-plus"></i>
                            </button>
                            <button class="action-btn edit-btn btn btn-sm btn-info ${editModeActive ? '' : 'hidden-edit-button'}" data-id="${product.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });

            productsContainer.appendChild(table);

            // Render pagination controls
            renderPaginationControls(totalPages);

            // Agregar event listeners a los botones de agregar al carrito
            document.querySelectorAll('.add-to-cart').forEach(button => {
                button.addEventListener('click', (e) => {
                    const productId = parseInt(e.target.closest('.add-to-cart').dataset.id);
                    addToCart(productId);
                });
            });

            // Add event listeners for edit buttons
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const productId = parseInt(e.target.closest('.edit-btn').dataset.id);
                    openUpdateProductModal(productId);
                });
            });
        }

        // Function to render pagination controls
        function renderPaginationControls(totalPages) {
            paginationControls.style.display = totalPages > 1 ? 'flex' : 'none'; // Show only if more than 1 page
            pageInfoSpan.textContent = `Página ${currentPage} de ${totalPages}`;
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages;
        }

        // Función para agregar producto al carrito
        function addToCart(productId) {
            const product = products.find(p => p.id === productId);

            if (!product) {
                showStatusMessage('Producto no encontrado', 'error');
                return;
            }

            // Verificar si el producto ya está en el carrito
            const existingItem = cart.find(item => item.id === productId);

            if (existingItem) {
                // Verificar si hay suficiente stock
                if (existingItem.quantity < product.stock) {
                    existingItem.quantity += 1;
                    product.lastUpdateDate = new Date().toLocaleString(); // Update last update date
                }
                else {
                    showStatusMessage(`No hay suficiente stock de ${product.name}. Solo quedan ${product.stock} unidades.`, 'error');
                    return;
                }
            } else {
                // Agregar nuevo producto al carrito
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    quantity: 1
                    // icon: product.icon // Removed
                });
                // No need to update product.lastUpdateDate here as it's not a direct stock change on the product itself
            }

            // Actualizar carrito
            updateCart();

            // Mostrar mensaje de confirmación
            showStatusMessage(`${product.name} agregado al carrito`, 'success');
            saveProductsToLocalStorage();
        }

        // Función para actualizar carrito
        function updateCart() {
            // Mostrar/ocultar mensaje de carrito vacío
            if (cart.length === 0) {
                emptyCartElement.style.display = 'block';
                cartItemsContainer.innerHTML = '';
                cartItemsContainer.appendChild(emptyCartElement);
                checkoutBtn.disabled = true;
            }
            else {
                emptyCartElement.style.display = 'none';

                // Limpiar contenedor de items del carrito
                cartItemsContainer.innerHTML = '';

                // Renderizar cada item del carrito
                cart.forEach(item => {
                    const cartItemElement = document.createElement('div');
                    cartItemElement.className = 'cart-item';
                    cartItemElement.innerHTML = `
                        <div class="cart-item-info">
                            <h4>${item.name}</h4>
                            <div class="cart-item-price">${formatPrice(item.price)} c/u</div>
                        </div>
                        <div class="cart-item-controls">
                            <input type="number" class="item-quantity" data-id="${item.id}" value="${item.quantity}" min="0.01" step="0.01" max="${products.find(p => p.id === item.id).stock}">
                            <button class="remove-item" data-id="${item.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;

                    cartItemsContainer.appendChild(cartItemElement);
                });

                // Habilitar botón de checkout
                checkoutBtn.disabled = false;

                // Agregar event listeners a los controles de cantidad (input change)
                document.querySelectorAll('.item-quantity').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const productId = parseInt(e.target.dataset.id);
                        const newQuantity = parseFloat(e.target.value);
                        updateQuantityFromInput(productId, newQuantity);
                    });
                });

                // Agregar event listeners a los botones de eliminar
                document.querySelectorAll('.remove-item').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const productId = parseInt(e.target.closest('.remove-item').dataset.id);
                        removeFromCart(productId);
                    });
                });
            }

            // Calcular y actualizar totales
            calculateTotals();
        }

        // Función para actualizar cantidad de un producto en el carrito desde input
        function updateQuantityFromInput(productId, newQuantity) {
            const item = cart.find(item => item.id === productId);
            const product = products.find(p => p.id === productId);

            if (item) {
                if (isNaN(newQuantity) || newQuantity < 0.01) {
                    newQuantity = 0.01;
                }
                if (newQuantity > product.stock) {
                    showStatusMessage(`No hay suficiente stock de ${product.name}. Solo quedan ${product.stock} unidades.`, 'error');
                    newQuantity = product.stock;
                }
                item.quantity = newQuantity;
                product.lastUpdateDate = new Date().toLocaleString();
                updateCart();
                saveProductsToLocalStorage();
            }
        }

        // Función para eliminar producto del carrito
        function removeFromCart(productId) {
            const item = cart.find(item => item.id === productId);
            cart = cart.filter(item => item.id !== productId);
            updateCart();

            if (item) {
                showStatusMessage(`${item.name} eliminado del carrito`, 'info');
            }
        }

        // Función para calcular totales (sin IVA)
        function calculateTotals() {
            let subtotal = 0;

            cart.forEach(item => {
                subtotal += item.price * item.quantity;
            });

            // No IVA calculation
            const total = subtotal;

            // Actualizar elementos del DOM
            subtotalElement.textContent = formatPrice(subtotal);
            totalElement.textContent = formatPrice(total);
        }

        // Función para procesar la venta
        function processSale() {
            // Verificar si el carrito tiene items
            if (cart.length === 0) {
                showStatusMessage("El carrito está vacío. Agrega productos antes de procesar la venta.", 'error');
                return;
            }

            // Generar ID de recibo aleatorio
            const receiptId = `PS-${Math.floor(Math.random() * 10000).toString().padStart(5, '0')}`;
            receiptIdElement.textContent = `ID: ${receiptId}`;

            // Actualizar fecha y hora en el recibo
            const now = new Date();
            receiptDateElement.textContent = now.toLocaleDateString('es-ES');
            receiptTimeElement.textContent = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });

            // Calcular total para el recibo
            let totalSale = 0;
            let receiptItemsHTML = '';

            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                totalSale += itemTotal;

                receiptItemsHTML += `
                    <div class="receipt-item">
                        <span>${item.name} x${item.quantity}</span>
                        <span>${formatPrice(itemTotal)}</span>
                    </div>
                `;
            });

            // Store sale data
            sales.push({
                id: receiptId,
                date: now.toLocaleDateString('es-ES'),
                time: now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }),
                total: totalSale,
                items: cart.map(item => ({
                    name: item.name,
                    quantity: item.quantity,
                    price: item.price
                    // icon: item.icon // Removed
                }))
            });
            saveSalesToLocalStorage();

            // Actualizar items y total en el recibo
            receiptItemsElement.innerHTML = receiptItemsHTML;
            receiptTotalElement.textContent = formatPrice(totalSale);

            // Mostrar modal de recibo
            receiptModal.style.display = 'flex';

            // Actualizar stock de productos
            cart.forEach(cartItem => {
                const product = products.find(p => p.id === cartItem.id);
                if (product) {
                    product.stock -= cartItem.quantity;
                    product.lastUpdateDate = new Date().toLocaleString();
                }
            });

            // Vaciar carrito
            cart = [];
            updateCart();

            // Actualizar lista de productos
            renderProducts();

            showStatusMessage('Venta procesada correctamente', 'success');
            saveProductsToLocalStorage();
        }

        // Función para imprimir recibo
        function printReceipt() {
            const printContent = document.querySelector('.receipt-content').innerHTML;
            const originalContent = document.body.innerHTML;

            document.body.innerHTML = `
                <html>
                    <head>
                        <title>Recibo PetShop</title>
                        <style>
                            body { font-family: Arial, sans-serif; padding: 20px; }
                            .receipt-content { width: 100%; }
                            .receipt-header { text-align: center; margin-bottom: 20px; }
                            .receipt-item { display: flex; justify-content: space-between; margin-bottom: 8px; }
                            .modal-buttons { display: none; }
                        </style>
                    </head>
                    <body>${printContent}</body>
                </html>
            `;

            window.print();
            document.body.innerHTML = originalContent;

            // Volver a cargar los event listeners
            initEventListeners();
        }

        // Function to open Add Product Modal
        function openAddProductModal() {
            addProductForm.reset();
            addProductFormStatusMessage.innerHTML = '';
            addProductModal.style.display = 'flex';
        }

        // Function to open Update Product Modal
        function openUpdateProductModal(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) {
                showStatusMessage('Producto no encontrado para actualizar', 'error');
                return;
            }

            // Populate form fields with product data
            updateProductIdInput.value = product.id;
            updateProductNameInput.value = product.name;
            updateProductPriceInput.value = product.price;
            updateProductCategoryInput.value = product.category;
            updateProductStockInput.value = product.stock;
            // updateProductIconInput.value = product.icon; // Removed
            updateProductFormStatusMessage.innerHTML = '';
            updateProductModal.style.display = 'flex';
        }

        // Function to close Add Product Modal
        function closeAddProductModal() {
            addProductModal.style.display = 'none';
        }

        // Function to close Update Product Modal
        function closeUpdateProductModal() {
            updateProductModal.style.display = 'none';
        }

        // Function to toggle edit mode
        function toggleEditMode() {
            const enteredPassword = prompt('Introduce la clave de administrador para activar/desactivar el modo edición:');

            if (enteredPassword === ADMIN_PASSWORD) {
                editModeActive = !editModeActive;

                // Select all edit buttons (within the table rows)
                const editButtons = document.querySelectorAll('.products-table .edit-btn');
                editButtons.forEach(button => {
                    if (editModeActive) {
                        button.classList.remove('hidden-edit-button');
                    } else {
                        button.classList.add('hidden-edit-button');
                    }
                });

                // Toggle visibility of add product button and excel controls
                const addProductBtn = document.getElementById('open-add-product-modal-btn');
                if (addProductBtn) {
                    if (editModeActive) {
                        addProductBtn.classList.remove('hidden-edit-button');
                    } else {
                        addProductBtn.classList.add('hidden-edit-button');
                    }
                }

                if (excelControls) {
                    if (editModeActive) {
                        excelControls.classList.remove('hidden-edit-button');
                    } else {
                        excelControls.classList.add('hidden-edit-button');
                    }
                }

                showStatusMessage(editModeActive ? 'Modo edición ACTIVADO' : 'Modo edición DESACTIVADO', 'info');
            } else if (enteredPassword !== null) {
                showStatusMessage('Clave incorrecta. El modo edición no se activó.', 'error');
            }
        }

        // Función para inicializar event listeners
        function initEventListeners() {
            // Event listener para la barra de búsqueda
            searchInput.addEventListener('input', () => { currentPage = 1; renderProducts(); }); // Reset page on search

            // Event listener para botón de checkout
            checkoutBtn.addEventListener('click', processSale);

            // Event listeners para el modal de recibo
            closeReceiptBtn.addEventListener('click', () => {
                receiptModal.style.display = 'none';
            });

            printBtn.addEventListener('click', printReceipt);

            // Cerrar modal al hacer clic fuera del contenido
            receiptModal.addEventListener('click', (e) => {
                if (e.target === receiptModal) {
                    receiptModal.style.display = 'none';
                }
            });

            // Event listener para cargar archivo Excel
            excelFileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];

                if (!file) {
                    return;
                }

                // Validar extensión del archivo
                const validExtensions = ['.xlsx', '.xls', '.csv'];
                const fileExtension = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();

                if (!validExtensions.includes(fileExtension)) {
                    showStatusMessage('Formato de archivo no válido. Usa .xlsx, .xls o .csv', 'error');
                    excelFileInput.value = '';
                    return;
                }

                // Actualizar información del archivo
                fileInfoElement.textContent = `Archivo: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;

                try {
                    showStatusMessage('Procesando archivo Excel...', 'info');

                    // Leer archivo Excel
                    const excelData = await readExcelFile(file);

                    // Procesar datos
                    products = processExcelData(excelData);

                    // Reset pagination and render UI
                    currentPage = 1;
                    renderCategories();
                    renderSubcategories(); // Call to maintain structure, but it will no longer render subcategories
                    renderProducts();

                    // Mostrar mensaje de éxito
                    showStatusMessage(`Archivo cargado correctamente: ${products.length} productos importados`, 'success');

                    // Restablecer selección de categoría y subcategoría
                    currentCategory = 'all';
                    currentSubcategory = 'all';

                } catch (error) {
                    showStatusMessage(`Error al cargar archivo: ${error.message}`, 'error');
                    console.error('Error al cargar archivo Excel:', error);
                }
            });

            // Event listener para descargar plantilla
            downloadTemplateBtn.addEventListener('click', downloadTemplate);

            // Event listener para exportar productos
            exportProductsBtn.addEventListener('click', exportToExcel);

            // Event listener para exportar ventas
            exportSalesBtn.addEventListener('click', exportSalesToExcel);

            // Event listeners for Add Product Modal
            openAddProductModalBtn.addEventListener('click', openAddProductModal);
            closeAddProductModalBtn.addEventListener('click', closeAddProductModal);
            addProductModal.addEventListener('click', (e) => {
                if (e.target === addProductModal) {
                    closeAddProductModal();
                }
            });

            // Event listener for Add Product Form submission
            addProductForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = addProductNameInput.value.trim();
                const price = parseFloat(addProductPriceInput.value);
                const category = addProductCategoryInput.value.trim().toLowerCase();
                const stock = parseInt(addProductStockInput.value);
                // const icon = addProductIconInput.value.trim(); // Removed

                if (!name || isNaN(price) || price <= 0 || !category || isNaN(stock) || stock < 0) {
                    showAddProductFormStatusMessage('Por favor, completa todos los campos correctamente.', 'error');
                    return;
                }

                // Check for existing product name
                if (products.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                    showAddProductFormStatusMessage(`Ya existe un producto con el nombre '${name}'.`, 'error');
                    return;
                }

                const now = new Date().toLocaleString();
                const newId = products.length > 0 ? Math.max(...products.map(p => p.id)) + 1 : 1;

                const newProduct = {
                    id: newId,
                    name,
                    price,
                    category,
                    stock,
                    // icon: icon || getDefaultImageUrlForCategory(category), // Removed
                    // subcategory: '', // Removed
                    creationDate: now,
                    lastUpdateDate: now,
                    previousStock: 0
                };

                products.push(newProduct);
                showAddProductFormStatusMessage(`Producto '${name}' agregado correctamente.`, 'success');
                closeAddProductModal();
                currentPage = 1; // Reset to first page after adding a new product
                renderCategories();
                // renderSubcategories(); // Subcategory logic removed
                renderProducts();
                saveProductsToLocalStorage();
            });

            // Event listeners for Update Product Modal
            closeUpdateProductModalBtn.addEventListener('click', closeUpdateProductModal);
            updateProductModal.addEventListener('click', (e) => {
                if (e.target === updateProductModal) {
                    closeUpdateProductModal();
                }
            });

            // Event listener for Update Product Form submission
            updateProductForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const id = parseInt(updateProductIdInput.value);
                const name = updateProductNameInput.value.trim();
                const price = parseFloat(updateProductPriceInput.value);
                const category = updateProductCategoryInput.value.trim().toLowerCase();
                const stock = parseInt(updateProductStockInput.value);
                // const icon = updateProductIconInput.value.trim(); // Removed

                if (!name || isNaN(price) || price <= 0 || !category || isNaN(stock) || stock < 0) {
                    showUpdateProductFormStatusMessage('Por favor, completa todos los campos correctamente.', 'error');
                    return;
                }

                const productIndex = products.findIndex(p => p.id === id);
                if (productIndex > -1) {
                    // Check for duplicate name for other products
                    if (products.some((p, idx) => p.name.toLowerCase() === name.toLowerCase() && idx !== productIndex)) {
                        showUpdateProductFormStatusMessage(`Ya existe otro producto con el nombre '${name}'.`, 'error');
                        return;
                    }

                    const now = new Date().toLocaleString();
                    const oldProduct = products[productIndex];
                    products[productIndex] = {
                        ...products[productIndex],
                        name,
                        price,
                        category,
                        stock,
                        // icon: icon || getDefaultImageUrlForCategory(category), // Removed
                        lastUpdateDate: now,
                        previousStock: oldProduct.stock
                    };
                    showUpdateProductFormStatusMessage(`Producto '${name}' actualizado correctamente.`, 'success');
                    closeUpdateProductModal();
                    renderCategories();
                    // renderSubcategories(); // Subcategory logic removed
                    renderProducts();
                    saveProductsToLocalStorage();
                } else {
                    showUpdateProductFormStatusMessage('Error: Producto no encontrado para actualizar.', 'error');
                }
            });

            // Event listener for toggle edit mode button
            toggleEditModeBtn.addEventListener('click', toggleEditMode);

            // Pagination event listeners
            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderProducts();
                }
            });

            nextPageBtn.addEventListener('click', () => {
                const totalPages = Math.ceil(products.filter(p => p.stock > 0 && (currentCategory === 'all' || p.category === currentCategory) && p.name.toLowerCase().includes(searchInput.value.toLowerCase())).length / productsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderProducts();
                }
            });
        }

        // Cargar datos iniciales desde localStorage si existen
        function loadInitialData() {
            const savedProducts = localStorage.getItem('petshop_products');
            const savedSales = localStorage.getItem('petshop_sales');
            const now = new Date().toLocaleString();

            if (savedProducts) {
                try {
                    products = JSON.parse(savedProducts);
                    // Ensure loaded products have date fields, add if missing
                    products = products.map(p => ({
                        ...p,
                        creationDate: p.creationDate || now,
                        lastUpdateDate: p.lastUpdateDate || now,
                        previousStock: p.previousStock !== undefined ? p.previousStock : p.stock
                        // icon: p.icon || getDefaultImageUrlForCategory(p.category), // Removed
                        // subcategory: p.subcategory || '' // Removed
                    }));
                    showStatusMessage(`Datos cargados desde almacenamiento local: ${products.length} productos`, 'info');
                } catch (error) {
                    console.error('Error al cargar datos desde localStorage:', error);
                    products = [];
                }
            }

            if (savedSales) {
                try {
                    sales = JSON.parse(savedSales);
                } catch (error) {
                    console.error('Error al cargar ventas desde localStorage:', error);
                    sales = [];
                }
            }

             // Si no hay productos cargados o guardados, cargar datos de ejemplo
            if (products.length === 0) {
                products = [
                    { id: 1, name: "Alimento para Perro Adulto", price: 450, category: "food", stock: 15, creationDate: now, lastUpdateDate: now, previousStock: 15 },
                    { id: 2, name: "Alimento para Gato Adulto", price: 380, category: "food", stock: 12, creationDate: now, lastUpdateDate: now, previousStock: 12 },
                    { id: 3, name: "Snacks para Perro", price: 120, category: "food", stock: 25, creationDate: now, lastUpdateDate: now, previousStock: 25 },
                    { id: 4, name: "Pelota para Mascota", price: 85, category: "toys", stock: 30, creationDate: now, lastUpdateDate: now, previousStock: 30 },
                    { id: 5, name: "Collar de Perro", price: 60, category: "accessories", stock: 10, creationDate: now, lastUpdateDate: now, previousStock: 10 },
                    { id: 6, name: "Rascador para Gato", price: 200, category: "toys", stock: 5, creationDate: now, lastUpdateDate: now, previousStock: 5 },
                    { id: 7, name: "Antipulgas", price: 150, category: "health", stock: 20, creationDate: now, lastUpdateDate: now, previousStock: 20 },
                    { id: 8, name: "Arena para Gato", price: 90, category: "food", stock: 18, creationDate: now, lastUpdateDate: now, previousStock: 18 }
                ];

                showStatusMessage('Usando datos de ejemplo. Carga un archivo Excel para importar tus productos.', 'info');
            }
        }

        // Guardar productos en localStorage
        function saveProductsToLocalStorage() {
            localStorage.setItem('petshop_products', JSON.stringify(products));
        }

        // Guardar ventas en localStorage
        function saveSalesToLocalStorage() {
            localStorage.setItem('petshop_sales', JSON.stringify(sales));
        }

        // Inicializar la aplicación
        function initApp() {
            updateDateTime();
            loadInitialData();
            renderCategories();
            renderSubcategories();
            renderProducts();
            updateCart();
            initEventListeners();

            // Guardar productos automáticamente cada 30 segundos
            setInterval(saveProductsToLocalStorage, 30000);
            setInterval(saveSalesToLocalStorage, 30000);

            // Guardar también al cerrar la página
            window.addEventListener('beforeunload', () => {
                saveProductsToLocalStorage();
                saveSalesToLocalStorage();
            });
        }

        // Inicializar cuando el DOM esté cargado
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
